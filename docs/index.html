<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PA Framework | Cockpit</title>

    <!-- Offline assets (local-first) -->
    <script src="lib/tailwind.js"></script>
    <script src="lib/lucide.min.js"></script>
    <script src="lib/alpine.min.js" defer></script>
    <script src="lib/marked.min.js"></script>
    <script src="docs_manifest.js"></script>
    <script src="status.js"></script>

    <style>
        body { font-family: "Segoe UI", "Segoe UI Variable", "Tahoma", "Verdana", sans-serif; background-color: #020617; color: #f8fafc; }
        .glass { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .glass-card { background: rgba(30, 41, 59, 0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; transition: all 0.2s ease; }
        .glass-card:hover { border-color: rgba(52, 211, 153, 0.3); transform: translateY(-2px); }
        [x-cloak] { display: none !important; }
        pre, code { font-family: "Cascadia Mono", "Consolas", "Menlo", monospace; }
        .prose pre { background-color: #0f172a !important; border: 1px solid #1e293b; padding: 1rem; border-radius: 0.75rem; }
        .prose h1, .prose h2, .prose h3 { color: #f8fafc; margin-top: 1.5em; margin-bottom: 0.5em; font-weight: 700; }
        .prose p { margin-bottom: 1em; line-height: 1.7; color: #cbd5e1; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        .bl-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .bl-table th { text-align: left; padding: 1rem; border-bottom: 1px solid #1e293b; color: #94a3b8; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .bl-table td { padding: 1rem; border-bottom: 1px solid #0f172a; vertical-align: top; }
        .priority-vitals { color: #f43f5e; background: #f43f5e1a; border: 1px solid #f43f5e33; }
        .priority-high { color: #fbbf24; background: #fbbf241a; border: 1px solid #fbbf2433; }
        .priority-media { color: #38bdf8; background: #38bdf81a; border: 1px solid #38bdf833; }
        .priority-baja { color: #94a3b8; background: #94a3b81a; border: 1px solid #94a3b833; }
        
        .bar-container { display: flex; align-items: flex-end; gap: 8px; height: 120px; padding-top: 20px; }
        .bar { background: #10b981; border-radius: 4px 4px 0 0; transition: height 0.5s ease; position: relative; min-width: 20px; flex: 1; opacity: 0.6; cursor: pointer; }
        .bar:hover { opacity: 1; background: #34d399; transform: scaleX(1.1); }
        .bar::after { content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; white-space: nowrap; border: 1px solid #334155; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .bar:hover::after { opacity: 1; }
    </style>
</head>
<body class="h-screen flex overflow-hidden" x-data="cockpitData()" x-init="init()">

    <!-- Sidebar -->
    <nav class="w-64 bg-slate-950 border-r border-slate-800 flex flex-col z-20">
        <div class="p-6 border-b border-slate-800">
            <img src="lib/logo-horizontal.png" alt="FreakingJSON" class="h-8 mb-2 opacity-90">
            <div class="flex items-center gap-2 mt-2">
                <span class="text-[10px] uppercase tracking-wider font-bold px-1.5 py-0.5 rounded bg-rose-500/20 text-rose-400 border border-rose-500/30" x-text="frameworkStage"></span>
                <span class="text-xs text-slate-500 font-mono" x-text="frameworkVersion"></span>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto py-4 space-y-1">
            <button @click="currentTab = 'home'" :class="navClass('home')" class="w-full text-left px-6 py-3 flex items-center gap-3 transition-all">
                <i data-lucide="home" size="18"></i> <span x-text="strings.nav_dashboard"></span>
            </button>
            <button @click="currentTab = 'docs'; if(!activeDoc) loadDoc(docsList[0])" :class="navClass('docs')" class="w-full text-left px-6 py-3 flex items-center gap-3 transition-all">
                <i data-lucide="book" size="18"></i> <span x-text="strings.nav_docs"></span>
            </button>
            <button @click="currentTab = 'backlog'" :class="navClass('backlog')" class="w-full text-left px-6 py-3 flex items-center gap-3 transition-all">
                <i data-lucide="list-todo" size="18"></i> <span x-text="strings.nav_backlog"></span>
            </button>
            <button @click="currentTab = 'stats'" :class="navClass('stats')" class="w-full text-left px-6 py-3 flex items-center gap-3 transition-all">
                <i data-lucide="bar-chart-2" size="18"></i> <span x-text="strings.nav_stats"></span>
            </button>

            <div class="px-6 py-4 mt-4">
                <h4 class="text-[10px] font-bold text-slate-600 uppercase tracking-widest mb-2" x-text="strings.workspaces_label"></h4>
                <div class="space-y-1">
                    <template x-for="ws in workspaces" :key="ws.id">
                        <button @click="openWorkspaceInfo(ws)" class="w-full text-left text-xs text-slate-500 hover:text-emerald-400 hover:bg-slate-900 flex items-center gap-2 px-2 py-1.5 rounded transition-all">
                            <i data-lucide="folder" size="12"></i>
                            <span x-text="ws.id"></span>
                        </button>
                    </template>
                </div>
            </div>
        </div>
        
        <div class="p-4 border-t border-slate-800">
             <a href="https://github.com/n30j0su3/Model-Agnostic-AI-Personal-Assistant-Framework" target="_blank" class="flex items-center gap-2 text-xs text-slate-500 hover:text-white transition-colors">
                <i data-lucide="github" size="14"></i>
                <span x-text="strings.github_repo"></span>
            </a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-[#020617] relative">
        <header class="sticky top-0 z-10 glass border-b border-slate-800 px-8 py-4 flex items-center justify-between">
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-2 text-xs">
                    <span class="w-2 h-2 rounded-full" :class="serverActive ? 'bg-emerald-500' : 'bg-rose-500'"></span>
                    <span class="text-slate-400" x-text="serverActive ? strings.system_ready : strings.server_disconnected"></span>
                </div>
                <div class="h-4 w-px bg-slate-800"></div>
                <div class="text-xs text-slate-400 flex items-center gap-2">
                    <i data-lucide="clock" size="14"></i>
                    <span x-text="strings.last_sync"></span>
                    <span class="text-slate-200" x-text="lastSync"></span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <select x-model="currentLang" @change="updateLang" class="bg-slate-900 text-xs border border-slate-700 rounded px-2 py-1 outline-none text-slate-300">
                    <option value="es">ES</option>
                    <option value="en">EN</option>
                </select>
            </div>
        </header>

        <div class="p-8 md:p-12">
            <!-- Tab: HOME -->
            <div x-show="currentTab === 'home'" x-transition.opacity class="max-w-6xl mx-auto space-y-10">
                <div class="relative overflow-hidden rounded-3xl p-10 bg-gradient-to-br from-emerald-900/20 via-slate-900 to-slate-950 border border-emerald-500/10">
                    <div class="relative z-10 space-y-4">
                        <h2 class="text-4xl font-bold text-white tracking-tight flex items-center gap-3">
                            <span x-text="strings.welcome_user">Bienvenido</span>
                            <span class="text-emerald-500 text-lg border border-emerald-500/30 px-3 py-1 rounded-full bg-emerald-500/10">v1.6.3-alpha</span>
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-6">
                            <div>
                                <h3 class="text-emerald-400 font-bold mb-2 uppercase tracking-wider text-xs">El Concepto</h3>
                                <p class="text-slate-400 text-sm leading-relaxed" x-text="strings.hero_concept"></p>
                            </div>
                            <div class="bg-slate-950/50 p-4 rounded-xl border border-slate-800 text-xs">
                                <h3 class="text-emerald-400 font-bold mb-2 uppercase tracking-wider text-xs">Arquitectura Híbrida</h3>
                                <div class="flex items-center gap-4">
                                    <div class="text-center">
                                        <div class="w-10 h-10 rounded-lg bg-emerald-500/20 flex items-center justify-center mb-1 mx-auto text-emerald-400"><i data-lucide="layout-dashboard"></i></div>
                                        <span class="font-bold text-slate-200">Front (Dash)</span>
                                    </div>
                                    <div class="h-px flex-1 bg-slate-700"></div>
                                    <div class="text-center">
                                        <div class="w-10 h-10 rounded-lg bg-slate-800 flex items-center justify-center mb-1 mx-auto text-white"><i data-lucide="terminal"></i></div>
                                        <span class="font-bold text-slate-200">Back (CLI)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: BACKLOG -->
            <div x-show="currentTab === 'backlog'" x-cloak x-transition.opacity class="max-w-6xl mx-auto space-y-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold text-white" x-text="strings.backlog_title"></h2>
                        <p class="text-sm text-slate-500" x-text="strings.backlog_subtitle"></p>
                    </div>
                    <button @click="openBacklogModal()" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg shadow-emerald-600/20">
                        <i data-lucide="plus" class="inline mr-1" size="16"></i> <span x-text="strings.add_item"></span>
                    </button>
                </div>
                <!-- Filters -->
                <div class="glass-card p-4 flex gap-4">
                    <input type="text" x-model="blSearch" @input="filterBacklog()" :placeholder="strings.search_tasks" class="flex-1 bg-slate-950 border border-slate-800 rounded-lg px-4 py-2 text-sm focus:border-emerald-500 outline-none text-white">
                    <select x-model="blPriority" @change="filterBacklog()" class="bg-slate-950 border border-slate-800 rounded-lg px-4 py-2 text-sm text-slate-300 outline-none">
                        <option value="all" x-text="strings.all_priorities"></option>
                        <option value="CORE VITALS">Core Vitals</option>
                        <option value="Alta">Alta</option>
                        <option value="Media">Media</option>
                        <option value="Baja">Baja</option>
                    </select>
                    <select x-model="blStatus" @change="filterBacklog()" class="bg-slate-950 border border-slate-800 rounded-lg px-4 py-2 text-sm text-slate-300 outline-none">
                        <option value="all" x-text="strings.all_statuses"></option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="Hecho">Hecho</option>
                    </select>
                </div>
                <div class="glass-card overflow-hidden">
                    <table class="bl-table">
                        <thead>
                            <tr>
                                <th @click="setSort('id')" class="cursor-pointer select-none">ID <span class="text-[10px] text-slate-600" x-text="sortIndicator('id')"></span></th>
                                <th @click="setSort('label')" class="cursor-pointer select-none">Item <span class="text-[10px] text-slate-600" x-text="sortIndicator('label')"></span></th>
                                <th @click="setSort('priority')" class="cursor-pointer select-none">Priority <span class="text-[10px] text-slate-600" x-text="sortIndicator('priority')"></span></th>
                                <th @click="setSort('status')" class="cursor-pointer select-none">Status <span class="text-[10px] text-slate-600" x-text="sortIndicator('status')"></span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="item in filteredBacklog" :key="item.id">
                                <tr class="hover:bg-slate-900/50 transition-colors">
                                    <td class="font-mono text-[10px] text-emerald-500/70" x-text="item.id"></td>
                                    <td>
                                        <div class="font-bold text-slate-200 text-sm" x-text="item.label"></div>
                                        <div class="text-[11px] text-slate-500 mt-0.5 truncate max-w-sm" x-text="item.desc"></div>
                                    </td>
                                    <td><span class="text-[9px] font-bold px-1.5 py-0.5 rounded uppercase" :class="{ 'priority-vitals': item.priority === 'CORE VITALS', 'priority-high': item.priority === 'Alta', 'priority-media': item.priority === 'Media', 'priority-baja': item.priority === 'Baja' }" x-text="item.priority"></span></td>
                                    <td><span class="text-[9px] font-bold px-1.5 py-0.5 rounded border border-slate-700 bg-slate-800 text-slate-400" x-text="item.status"></span></td>
                                    <td>
                                        <div class="flex gap-3">
                                            <button @click="openBacklogModal(item)" class="text-slate-500 hover:text-emerald-400 transition-colors">
                                                <i data-lucide="edit-3" size="14"></i>
                                            </button>
                                            <button @click="deleteBacklogItem(item)" class="text-slate-500 hover:text-rose-400 transition-colors">
                                                <i data-lucide="trash-2" size="14"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: STATS -->
            <div x-show="currentTab === 'stats'" x-cloak class="max-w-6xl mx-auto space-y-6">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-white" x-text="strings.stats_title"></h2>
                    <button @click="copyToClipboard('python scripts/history_engine.py')" class="text-xs bg-slate-900 border border-slate-800 px-4 py-2 rounded-xl text-slate-400 hover:text-white transition-all">
                        <i data-lucide="copy" class="inline mr-2" size="12"></i>
                        <span x-text="strings.stats_generate"></span>
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="glass-card p-6 text-center">
                        <div class="text-[10px] text-slate-500 font-bold mb-1 uppercase tracking-widest">Sesiones Totales</div>
                        <div class="text-4xl font-bold text-white" x-text="statsData?.total_sessions || 0"></div>
                    </div>
                    <div class="glass-card p-6 text-center">
                        <div class="text-[10px] text-slate-500 font-bold mb-1 uppercase tracking-widest">Tokens Est.</div>
                        <div class="text-4xl font-bold text-emerald-400" x-text="statsData?.total_tokens_estimated?.toLocaleString() || 0"></div>
                    </div>
                    <div class="glass-card p-6 text-center">
                        <div class="text-[10px] text-slate-500 font-bold mb-1 uppercase tracking-widest">Ultima Actividad</div>
                        <div class="text-lg font-bold text-slate-200" x-text="formatDate(statsData?.last_activity)"></div>
                    </div>
                    <div class="glass-card p-6 text-center">
                        <div class="text-[10px] text-slate-500 font-bold mb-1 uppercase tracking-widest" x-text="strings.stats_prompts"></div>
                        <div class="text-4xl font-bold text-white" x-text="statsData?.prompt_stats?.total_prompts || 0"></div>
                    </div>
                    
                    <!-- Graph -->
                    <div class="md:col-span-4 glass-card p-8">
                        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-6">Frecuencia de Actividad</h3>
                        <div class="bar-container border-b border-slate-800">
                             <!-- Generate some dummy bars if data is sparse to show the design -->
                             <template x-for="(count, date) in statsData?.sessions_by_date" :key="date">
                                <div class="bar" :style="`height: ${Math.max(count * 15, 10)}%`" :data-tooltip="date + ': ' + count + ' sesiones'"></div>
                             </template>
                             <div x-show="!statsData?.sessions_by_date" class="w-full text-center text-slate-600 text-xs pb-4 italic">Analizando sesiones locales...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab: DOCS -->
            <div x-show="currentTab === 'docs'" x-cloak class="max-w-6xl mx-auto">
                 <div class="grid grid-cols-1 lg:grid-cols-[240px_1fr] gap-6">
                    <div class="glass-card h-[75vh] flex flex-col overflow-hidden">
                        <div class="p-4 border-b border-slate-800 bg-slate-900/50 font-bold text-[10px] uppercase text-slate-500 tracking-widest">Docs Hub</div>
                        <div class="flex-1 overflow-y-auto p-2 scrollbar-hide">
                             <template x-for="doc in docsList" :key="doc.path">
                                <button @click="loadDoc(doc)" class="w-full text-left px-3 py-2 rounded-lg text-xs mb-0.5 transition-colors"
                                    :class="activeDoc?.path === doc.path ? 'bg-emerald-500/10 text-emerald-400 font-bold' : 'text-slate-400 hover:text-white hover:bg-slate-900'">
                                    <span x-text="doc.label"></span>
                                </button>
                            </template>
                        </div>
                    </div>
                    <div class="glass-card h-[75vh] flex flex-col overflow-hidden">
                        <div class="p-3 border-b border-slate-800 bg-slate-900/20 text-[10px] font-mono text-emerald-500/50 px-6" x-text="activeDoc?.path"></div>
                        <div class="flex-1 overflow-y-auto p-10 prose prose-invert prose-emerald max-w-none">
                            <div x-html="docContent"></div>
                        </div>
                    </div>
                 </div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div x-show="activeWorkspace" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm" x-cloak>
        <div class="glass-card w-full max-w-md p-8 relative" @click.away="activeWorkspace = null">
            <button @click="activeWorkspace = null" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i data-lucide="x"></i></button>
            <div class="flex items-center gap-3 mb-4 text-emerald-400"><i data-lucide="folder" size="24"></i><h3 class="text-2xl font-bold text-white" x-text="activeWorkspace?.id"></h3></div>
            <p class="text-slate-400 text-sm mb-6" x-text="activeWorkspace?.desc"></p>
            <div class="bg-slate-950 p-4 rounded-xl border border-slate-800">
                <h4 class="text-[10px] font-bold text-slate-600 uppercase mb-3">Ejemplos de Uso</h4>
                <ul class="space-y-2"><template x-for="ex in activeWorkspace?.examples" :key="ex"><li class="text-xs text-slate-400 flex gap-2"><i data-lucide="check" size="12" class="text-emerald-500 mt-0.5"></i> <span x-text="ex"></span></li></template></ul>
            </div>
        </div>
    </div>

    <div x-show="editingItem" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm" x-cloak>
        <div class="glass-card w-full max-w-xl p-8 relative" @click.away="editingItem = null">
            <h3 class="text-xl font-bold text-white mb-6" x-text="editingItem?.id ? 'Editar Tarea' : 'Nueva Tarea'"></h3>
            <div class="grid grid-cols-2 gap-4 mb-4 text-xs">
                <div><label class="text-slate-500 mb-1 block">ID</label><input type="text" x-model="editingItem.id" class="w-full bg-slate-950 border border-slate-800 rounded p-2 text-white outline-none"></div>
                <div><label class="text-slate-500 mb-1 block">Prioridad</label><select x-model="editingItem.priority" class="w-full bg-slate-950 border border-slate-800 rounded p-2 text-white outline-none"><option>Baja</option><option>Media</option><option>Alta</option><option>CORE VITALS</option></select></div>
            </div>
            <div class="mb-4 text-xs"><label class="text-slate-500 mb-1 block">Título</label><input type="text" x-model="editingItem.label" class="w-full bg-slate-950 border border-slate-800 rounded p-2 text-white outline-none"></div>
            <div class="mb-6 text-xs"><label class="text-slate-500 mb-1 block">Descripción</label><textarea x-model="editingItem.desc" rows="4" class="w-full bg-slate-950 border border-slate-800 rounded p-2 text-white outline-none"></textarea></div>
            <div class="flex justify-end gap-3">
                <button @click="editingItem = null" class="px-4 py-2 text-xs text-slate-400 hover:text-white">Cancelar</button>
                <button @click="saveBacklogItem()" class="px-6 py-2 bg-emerald-600 text-white rounded-lg text-xs font-bold shadow-lg shadow-emerald-600/20">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-10 right-10 bg-emerald-500 text-slate-950 px-6 py-4 rounded-2xl shadow-2xl shadow-emerald-500/20 transform translate-y-32 opacity-0 transition-all duration-500 flex items-center gap-3 z-50 font-bold">
        <i data-lucide="info" size="18"></i> <span id="toast-msg"></span>
    </div>

    <script>
        const I18N = {
            es: {
                nav_dashboard: "Panel de Control", nav_docs: "Documentación", nav_backlog: "Backlog", nav_stats: "Estadísticas",
                workspaces_label: "Workspaces", github_repo: "GitHub Repo", system_ready: "Online", server_disconnected: "Offline", last_sync: "Sinc:",
                welcome_user: "Bienvenido al Cockpit", hero_concept: "Este Dashboard es tu 'Frontend' visual. Actualmente interactúas con el 'Backend' vía CLI, pero estamos evolucionando hacia una experiencia unificada.",
                quick_actions: "Acciones Rápidas", backlog_title: "Gestión de Tareas", backlog_subtitle: "Roadmap interactivo del framework.",
                add_item: "Nueva Tarea", search_tasks: "Buscar...", all_priorities: "Prioridades", all_statuses: "Estados",
                confirm_save: "¿Guardar cambios en el backlog local?", confirm_delete: "¿Eliminar {id}? Esta accion es permanente.",
                save_success: "Backlog actualizado.", save_error: "Error al guardar el backlog.", delete_success: "Tarea eliminada.",
                missing_fields: "Completa ID y Título antes de guardar.",
                stats_title: "Estadísticas", stats_generate: "Generar stats", stats_prompts: "Prompts Totales"
            },
            en: {
                nav_dashboard: "Dashboard", nav_docs: "Documentation", nav_backlog: "Backlog", nav_stats: "Statistics",
                workspaces_label: "Workspaces", github_repo: "GitHub Repo", system_ready: "Online", server_disconnected: "Offline", last_sync: "Sync:",
                welcome_user: "Welcome to Cockpit", hero_concept: "This Dashboard is your visual 'Frontend'. We are evolving towards a unified experience from here.",
                quick_actions: "Quick Actions", backlog_title: "Task Management", backlog_subtitle: "Interactive roadmap.",
                add_item: "New Task", search_tasks: "Search...", all_priorities: "Priorities", all_statuses: "Statuses",
                confirm_save: "Save backlog changes locally?", confirm_delete: "Delete {id}? This action is permanent.",
                save_success: "Backlog updated.", save_error: "Failed to save backlog.", delete_success: "Task deleted.",
                missing_fields: "Fill ID and Title before saving.",
                stats_title: "Statistics", stats_generate: "Generate stats", stats_prompts: "Total Prompts"
            }
        };

        const WORKSPACES_INFO = [
            { id: '@personal', desc: 'Vida personal y finanzas.', examples: ['Viajes', 'Gastos'] },
            { id: '@professional', desc: 'Trabajo y carrera.', examples: ['Emails', 'Slides'] },
            { id: '@development', desc: 'Código e ingeniería.', examples: ['Refactor', 'Tests'] },
            { id: '@content', desc: 'Multimedia y redes.', examples: ['YouTube', 'SEO'] },
            { id: '@research', desc: 'Investigación profunda.', examples: ['Papers', 'Análisis'] },
            { id: '@homelab', desc: 'Servidores y redes.', examples: ['Docker', 'HomeKit'] }
        ];

        function cockpitData() {
            return {
                currentTab: 'home', currentLang: 'es', strings: I18N.es, serverActive: true, lastSync: '...', statsData: null,
                workspaces: WORKSPACES_INFO, activeWorkspace: null,
                backlogItems: [], filteredBacklog: [], blSearch: '', blPriority: 'all', blStatus: 'all',
                blSortKey: 'id', blSortDir: 'asc', editingItem: null,
                docsList: window.DOCS_MANIFEST || [], activeDoc: null, docContent: '',
                quickActions: [
                    { label: 'Sync Context', desc: 'Alinear locales.', icon: 'refresh-cw', command: 'python scripts/sync-context.py' },
                    { label: 'CLI Panel', desc: 'Menú interactivo.', icon: 'terminal', command: 'python scripts/pa.py' },
                    { label: 'Actualizar', desc: 'Nuevas versiones.', icon: 'download', command: 'python scripts/update.py' },
                    { label: 'Orquestar', desc: 'Delegar agentes.', icon: 'zap', command: 'python agents/core/orchestrator/scripts/orchestrate.py' }
                ],
                init() { 
                    this.checkServer(); this.loadStats(); this.loadBacklog(); 
                    setInterval(() => this.checkServer(), 30000); 
                    if(this.docsList.length) this.loadDoc(this.docsList[0]);
                    // Observer to re-create icons when Alpine renders templates
                    this.$watch('filteredBacklog', () => this.$nextTick(() => lucide.createIcons()));
                    this.$watch('currentTab', () => this.$nextTick(() => lucide.createIcons()));
                },
                updateLang() { this.strings = I18N[this.currentLang]; },
                navClass(tab) { return this.currentTab === tab ? 'bg-emerald-500/10 text-emerald-400 border-r-2 border-emerald-500' : 'text-slate-400 hover:bg-slate-900 hover:text-white'; },
                async checkServer() { try { const res = await fetch('http://localhost:8085/api/status'); const data = await res.json(); this.serverActive = true; this.lastSync = data.last_sync || 'N/A'; } catch { this.serverActive = false; } },
                openWorkspaceInfo(ws) { this.activeWorkspace = ws; this.$nextTick(() => lucide.createIcons()); },
                async loadStats() { try { this.statsData = await (await fetch(`stats.json?v=${Date.now()}`)).json(); } catch {} },
                async loadBacklog() {
                    try {
                        const res = await fetch('http://localhost:8085/api/backlog');
                        const data = await res.json();
                        const rows = data.content.split('\n').filter(l => l.includes('| BL-'));
                        this.backlogItems = rows.map(row => {
                            const c = row.split('|').map(x => x.trim());
                            return { id: c[1], label: c[2], priority: c[3], status: c[4], desc: c[5] || '' };
                        });
                        this.filterBacklog();
                    } catch (e) { console.error(e); }
                },
                filterBacklog() { 
                    const filtered = this.backlogItems.filter(i => 
                        (this.blPriority === 'all' || i.priority === this.blPriority) && 
                        (this.blStatus === 'all' || i.status === this.blStatus) &&
                        (i.label.toLowerCase().includes(this.blSearch.toLowerCase()))
                    );
                    const dir = this.blSortDir === 'asc' ? 1 : -1;
                    filtered.sort((a, b) => {
                        const av = this.sortValue(a, this.blSortKey);
                        const bv = this.sortValue(b, this.blSortKey);
                        if (av === bv) return 0;
                        return av > bv ? dir : -dir;
                    });
                    this.filteredBacklog = filtered;
                },
                setSort(key) {
                    if (this.blSortKey === key) {
                        this.blSortDir = this.blSortDir === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.blSortKey = key;
                        this.blSortDir = 'asc';
                    }
                    this.filterBacklog();
                },
                sortIndicator(key) {
                    if (this.blSortKey !== key) return '';
                    return this.blSortDir === 'asc' ? '↑' : '↓';
                },
                sortValue(item, key) {
                    if (key === 'id') {
                        const num = parseInt(String(item.id || '').replace(/\D/g, ''), 10);
                        return Number.isNaN(num) ? String(item.id || '').toLowerCase() : num;
                    }
                    if (key === 'label') return String(item.label || '').toLowerCase();
                    if (key === 'priority') {
                        const order = { 'CORE VITALS': 0, 'Alta': 1, 'Media': 2, 'Baja': 3 };
                        return order[item.priority] ?? 99;
                    }
                    if (key === 'status') return String(item.status || '').toLowerCase();
                    return '';
                },
                openBacklogModal(item = null) { 
                    this.editingItem = item ? { ...item, originalId: item.id } : { id: 'BL-XXX', label: '', priority: 'Media', status: 'Pendiente', desc: '', originalId: null }; 
                    this.$nextTick(() => lucide.createIcons());
                },
                async saveBacklogItem() {
                    const item = {
                        id: (this.editingItem?.id || "").trim(),
                        label: (this.editingItem?.label || "").trim(),
                        priority: this.editingItem?.priority || "Media",
                        status: this.editingItem?.status || "Pendiente",
                        desc: (this.editingItem?.desc || "").trim()
                    };
                    if (!item.id || !item.label) {
                        this.alertUser(this.strings.missing_fields || "Completa ID y Título antes de guardar.");
                        return;
                    }
                    if (!confirm(this.strings.confirm_save || "¿Guardar cambios en el backlog local?")) {
                        return;
                    }
                    this.upsertBacklogItem(item, this.editingItem?.originalId || null);
                    const ok = await this.persistBacklog(false, this.strings.save_success || "Backlog actualizado.");
                    if (ok) {
                        this.editingItem = null;
                    }
                },
                upsertBacklogItem(item, originalId) {
                    let targetIndex = -1;
                    if (originalId) {
                        targetIndex = this.backlogItems.findIndex(i => i.id === originalId);
                    }
                    if (targetIndex === -1) {
                        targetIndex = this.backlogItems.findIndex(i => i.id === item.id);
                    }
                    if (targetIndex >= 0) {
                        this.backlogItems.splice(targetIndex, 1, item);
                    } else {
                        this.backlogItems.push(item);
                        targetIndex = this.backlogItems.length - 1;
                    }
                    this.backlogItems = this.backlogItems.filter((i, idx) => idx === targetIndex || i.id !== item.id);
                },
                async persistBacklog(allowShrink, successMsg) {
                    try {
                        const res = await fetch('http://localhost:8085/api/backlog', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ items: this.backlogItems, allow_shrink: allowShrink })
                        });
                        if (!res.ok) {
                            const text = await res.text();
                            throw new Error(text || 'Error');
                        }
                        this.alertUser(successMsg);
                        await this.loadBacklog();
                        return true;
                    } catch (e) {
                        console.error(e);
                        this.alertUser(this.strings.save_error || "Error al guardar el backlog.");
                        return false;
                    }
                },
                deleteBacklogItem(item) {
                    const msg = (this.strings.confirm_delete || "¿Eliminar {id}?").replace("{id}", item.id);
                    if (!confirm(msg)) {
                        return;
                    }
                    this.backlogItems = this.backlogItems.filter(i => i.id !== item.id);
                    this.persistBacklog(true, this.strings.delete_success || "Tarea eliminada.");
                },
                alertUser(msg) { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = msg; t.classList.remove('translate-y-32', 'opacity-0'); setTimeout(() => t.classList.add('translate-y-32', 'opacity-0'), 4000); },
                copyToClipboard(txt) { navigator.clipboard.writeText(txt); this.alertUser('¡Copiado!'); },
                formatDate(iso) { if(!iso) return 'N/A'; return new Date(iso).toLocaleDateString(); },
                loadDoc(doc) {
                    this.activeDoc = doc;
                    fetch(doc.path).then(r => r.text()).then(t => { this.docContent = marked.parse(t); }).catch(() => this.docContent = 'Error.');
                }
            };
        }
        lucide.createIcons();
    </script>
</body>
</html>
